<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nasioneria — Ustawienia</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>
  <header class="topbar">
    <div class="brand">
      <div class="logo">
        <img src="logo.png" alt="Logo serwera Nasioneria" />
      </div>
      <div>
        <h1>Nasioneria</h1>
        <p>Sklep dla społeczności serwera</p>
      </div>
    </div>
    <nav class="actions">
      <div class="menu">
        <button class="btn ghost menu-trigger" type="button">Strona główna</button>
        <div class="menu-dropdown">
          <a href="index.html#sklep">Sklep</a>
          <a href="index.html#kontakt">Kontakt</a>
          <a href="index.html#social-media">Social media</a>
        </div>
      </div>
      <a class="btn ghost" href="login.html">Logowanie</a>
      <a class="btn" href="index.html">Strona główna</a>
    </nav>
  </header>

  <main>
    <section class="section">
      <div class="section-header">
        <h2>Ustawienia konta</h2>
        <p>Skonfiguruj bezpieczeństwo logowania.</p>
      </div>
      <p class="fine auth-message" id="authMessage" hidden></p>
      <div class="card" id="2fa">
        <h3>Weryfikacja 2‑etapowa</h3>
        <p class="fine">Po włączeniu podczas logowania pojawi się pole na kod 2FA.</p>
        <div class="hero-cta">
          <button class="btn" type="button" id="enable2fa">Włącz 2FA</button>
          <button class="btn ghost" type="button" id="disable2fa">Wyłącz 2FA</button>
        </div>
        <div id="twofaSetup" hidden>
          <p class="fine">Zeskanuj kod w aplikacji Authenticator:</p>
          <img id="twofaQr" alt="QR 2FA" />
          <p class="fine">Sekret: <span id="twofaSecret"></span></p>
        </div>
        <p class="status" id="twofaStatus" aria-live="polite"></p>
      </div>

      <div class="card" id="webauthn">
        <h3>Windows Hello</h3>
        <p class="fine">Po włączeniu podczas logowania pojawi się potwierdzenie systemowe.</p>
        <div class="hero-cta">
          <button class="btn" type="button" id="enableWebauthn">Włącz Windows Hello</button>
          <button class="btn ghost" type="button" id="disableWebauthn">Wyłącz Windows Hello</button>
        </div>
        <p class="status" id="webauthnStatus" aria-live="polite"></p>
      </div>

      <div class="card" id="admin" hidden>
        <h3>Administracja</h3>
        <p class="fine">Usunięcie wszystkich kont wymaga ADMIN_KEY.</p>
        <label>
          ADMIN_KEY
          <input type="password" id="adminKey" placeholder="ADMIN_KEY" />
        </label>
        <button class="btn ghost" type="button" id="clearUsers">Usuń wszystkie konta</button>
        <label>
          Wyłącz Windows Hello (email)
          <input type="email" id="disableWebauthnEmail" placeholder="email@domena.pl" />
        </label>
        <button class="btn ghost" type="button" id="disableWebauthnAdmin">Wyłącz Windows Hello</button>
        <p class="status" id="adminStatus" aria-live="polite"></p>
      </div>
    </section>
  </main>

  <footer class="footer">
    <p>© 2026 Nasioneria — wszystkie prawa zastrzeżone.</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/@simplewebauthn/browser/dist/bundle/index.umd.min.js"></script>
  <script>
    const authMessage = document.getElementById("authMessage");
    const enable2fa = document.getElementById("enable2fa");
    const disable2fa = document.getElementById("disable2fa");
    const twofaSetup = document.getElementById("twofaSetup");
    const twofaQr = document.getElementById("twofaQr");
    const twofaSecret = document.getElementById("twofaSecret");
    const twofaStatus = document.getElementById("twofaStatus");
    const enableWebauthn = document.getElementById("enableWebauthn");
    const disableWebauthn = document.getElementById("disableWebauthn");
    const webauthnStatus = document.getElementById("webauthnStatus");
    const adminSection = document.getElementById("admin");
    const adminKey = document.getElementById("adminKey");
    const clearUsers = document.getElementById("clearUsers");
    const disableWebauthnEmail = document.getElementById("disableWebauthnEmail");
    const disableWebauthnAdmin = document.getElementById("disableWebauthnAdmin");
    const adminStatus = document.getElementById("adminStatus");

    function getAuthUser() {
      try {
        return JSON.parse(localStorage.getItem("authUser") || "null");
      } catch {
        return null;
      }
    }

    function requireUser() {
      const user = getAuthUser();
      if (!user) {
        authMessage.textContent = "Zaloguj się, aby zarządzać ustawieniami.";
        authMessage.removeAttribute("hidden");
        return null;
      }
      authMessage.textContent = `Zalogowany jako ${user.email || user.nick}.`;
      authMessage.removeAttribute("hidden");
      const isAdmin = (user.email || "").toLowerCase() === "xdsleppy@gmail.com";
      adminSection?.toggleAttribute("hidden", !isAdmin);
      return user;
    }

    async function loadMethods() {
      const user = requireUser();
      if (!user) return;
      const res = await fetch(`/api/auth/methods?email=${encodeURIComponent(user.email)}`);
      if (!res.ok) return;
      const data = await res.json();
      twofaStatus.textContent = data.twofaEnabled ? "2FA włączone." : "2FA wyłączone.";
      twofaStatus.className = data.twofaEnabled ? "status success" : "status";
      webauthnStatus.textContent = data.webauthnEnabled ? "Windows Hello włączone." : "Windows Hello wyłączone.";
      webauthnStatus.className = data.webauthnEnabled ? "status success" : "status";
    }

    enable2fa?.addEventListener("click", async () => {
      const user = requireUser();
      if (!user) return;
      twofaStatus.textContent = "Włączanie 2FA...";
      const res = await fetch("/api/2fa/setup", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: user.email }),
      });
      const data = await res.json();
      if (!res.ok) {
        twofaStatus.textContent = data.message || "Nie udało się włączyć 2FA.";
        twofaStatus.className = "status error";
        return;
      }
      twofaQr.src = data.qrCodeDataURL;
      twofaSecret.textContent = data.secret;
      twofaSetup.removeAttribute("hidden");
      twofaStatus.textContent = data.message || "2FA włączone.";
      twofaStatus.className = "status success";
    });

    disable2fa?.addEventListener("click", async () => {
      const user = requireUser();
      if (!user) return;
      const res = await fetch("/api/2fa/disable", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: user.email }),
      });
      const data = await res.json();
      twofaStatus.textContent = data.message || "2FA wyłączone.";
      twofaStatus.className = res.ok ? "status success" : "status error";
      if (res.ok) twofaSetup.setAttribute("hidden", "");
    });

    enableWebauthn?.addEventListener("click", async () => {
      const user = requireUser();
      if (!user) return;
      webauthnStatus.textContent = "Uruchamianie Windows Hello...";
      webauthnStatus.className = "status";
      if (!window.isSecureContext) {
        webauthnStatus.textContent = "Windows Hello wymaga HTTPS.";
        webauthnStatus.className = "status error";
        return;
      }
      if (!window.SimpleWebAuthnBrowser) {
        webauthnStatus.textContent = "Brak wsparcia WebAuthn w przeglądarce.";
        webauthnStatus.className = "status error";
        return;
      }
      try {
        const optionsRes = await fetch("/api/webauthn/register/options", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: user.email }),
        });
        const options = await optionsRes.json();
        if (!optionsRes.ok) throw new Error(options.message || "Nie udało się pobrać opcji.");

        const response = await SimpleWebAuthnBrowser.startRegistration(options);
        const verifyRes = await fetch("/api/webauthn/register/verify", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: user.email, response }),
        });
        const verifyData = await verifyRes.json();
        webauthnStatus.textContent = verifyData.message || "Windows Hello włączone.";
        webauthnStatus.className = verifyRes.ok ? "status success" : "status error";
      } catch (error) {
        webauthnStatus.textContent = error?.message || "Nie udało się włączyć Windows Hello.";
        webauthnStatus.className = "status error";
      }
    });

    disableWebauthn?.addEventListener("click", async () => {
      const user = requireUser();
      if (!user) return;
      const res = await fetch("/api/webauthn/disable", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email: user.email }),
      });
      const data = await res.json();
      webauthnStatus.textContent = data.message || "Windows Hello wyłączone.";
      webauthnStatus.className = res.ok ? "status success" : "status error";
    });

    clearUsers?.addEventListener("click", async () => {
      const user = requireUser();
      if (!user) return;
      if ((user.email || "").toLowerCase() !== "xdsleppy@gmail.com") {
        adminStatus.textContent = "Brak uprawnień.";
        adminStatus.className = "status error";
        return;
      }
      adminStatus.textContent = "Usuwanie kont...";
      const res = await fetch("/api/admin/clear-users", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-admin-key": adminKey.value || "",
        },
        body: JSON.stringify({ adminKey: adminKey.value || "", email: user.email || "" }),
      });
      const data = await res.json();
      adminStatus.textContent = data.message || "Gotowe.";
      adminStatus.className = res.ok ? "status success" : "status error";
    });

    disableWebauthnAdmin?.addEventListener("click", async () => {
      const user = requireUser();
      if (!user) return;
      if ((user.email || "").toLowerCase() !== "xdsleppy@gmail.com") {
        adminStatus.textContent = "Brak uprawnień.";
        adminStatus.className = "status error";
        return;
      }
      const targetEmail = String(disableWebauthnEmail.value || "").trim();
      if (!targetEmail) {
        adminStatus.textContent = "Podaj e‑mail.";
        adminStatus.className = "status error";
        return;
      }
      adminStatus.textContent = "Wyłączanie Windows Hello...";
      const res = await fetch("/api/admin/webauthn/disable", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          "x-admin-key": adminKey.value || "",
        },
        body: JSON.stringify({
          adminKey: adminKey.value || "",
          adminEmail: user.email || "",
          targetEmail,
        }),
      });
      const data = await res.json();
      adminStatus.textContent = data.message || "Gotowe.";
      adminStatus.className = res.ok ? "status success" : "status error";
    });

    loadMethods();
  </script>
</body>
</html>
